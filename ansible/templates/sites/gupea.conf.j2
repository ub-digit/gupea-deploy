<VirtualHost *:80>
  ServerName {{ angular_hostname }}
  Redirect permanent / https://{{ angular_hostname }}/
</VirtualHost>

<VirtualHost *:443>
  ServerName {{ angular_hostname }}

  RequestHeader set X-Forwarded-Proto https
#  ProxyPass        /dflow-import http://127.0.0.1:30036/dflow_import
#  ProxyPassReverse /dflow-import http://127.0.0.1:30036/dflow_import

#  ProxyPass        /oai-uppsok http://127.0.0.1:30038/oai
#  ProxyPass        /oai-uppsok http://127.0.0.1:30038/oai

  ProxyPass        /espikning/assets http://127.0.0.1:30039/espikning/assets
  ProxyPassReverse /espikning/assets http://127.0.0.1:30039/espikning/assets
  ProxyPass        /espikning http://127.0.0.1:30039/
  ProxyPassReverse /espikning http://127.0.0.1:30039/
  # Bör lösas i applikationen

  ProxyPass        /server http://127.0.0.1:{{ dspace_host_port }}/server
  ProxyPassReverse /server http://127.0.0.1:{{ dspace_host_port }}/server

{% if inventory_hostname != 'production' %}
  # Mailpit for non production environments
  ProxyPass        /mail http://127.0.0.1:{{ mailpit_host_port }}/mail
  ProxyPassReverse /mail http://127.0.0.1:{{ mailpit_host_port }}/mail

  SSLProxyEngine on
  RewriteEngine on
  RewriteCond %{HTTP:Upgrade} websocket [NC]
  RewriteCond %{HTTP:Connection} upgrade [NC]
  RewriteRule ^/?(.*) "ws://127.0.0.1:{{ mailpit_host_port }}/$1" [P,L]
{% endif %}

  ProxyPass        / http://127.0.0.1:{{ angular_host_port }}/
  ProxyPassReverse / http://127.0.0.1:{{ angular_host_port }}/

  SSLEngine on
  SSLCertificateFile /etc/ssl/apache2/certs/ub-gu-se.pem
  SSLCertificateKeyFile /etc/ssl/apache2/private/ub-gu-se.key
  SSLCertificateChainFile /etc/ssl/apache2/certs/interm_geant.pem

# TODO:
#  <Location "/espikning">
#    AuthType Basic
#    AuthName "Restricted Content"
#    AuthUserFile /etc/apache2/conf-enabled/.htpasswd
#    Require valid-user
#  </Location>

</VirtualHost>

